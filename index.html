<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Route 7 Bus Times</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <!-- Google Fonts (Quicksand) -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- PWA Support -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#312E81">
    <link rel="icon" type="image/png" href="favicon.png">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="favicon.png">
    <script>
        // Function to apply dark mode based on preference/localStorage
        function applyDarkModePreference() {
            if (localStorage.theme === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }
        }
        applyDarkModePreference(); // Apply on initial load
        
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Quicksand', 'sans-serif'],
                    },
                    colors: {
                        primary: {
                            50: '#EEF2FF', 100: '#E0E7FF',
                            500: '#6366F1', 600: '#4F46E5',
                            700: '#4338CA', 800: '#3730A3',
                            900: '#312E81'
                        },
                        gray: { 
                            800: '#1F2937', 900: '#111827' 
                        }
                    },
                    animation: {
                        'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                        'fadeInUp': 'fadeInUp 0.5s ease-out forwards',
                        'slideDownFadeIn': 'slideDownFadeIn 0.3s ease-out forwards'
                    },
                    keyframes: {
                        fadeInUp: {
                            from: { opacity: 0, transform: 'translateY(10px)' },
                            to: { opacity: 1, transform: 'translateY(0)' },
                        },
                        slideDownFadeIn: {
                             from: { opacity: 0, transform: 'translateY(-20px)' },
                             to: { opacity: 1, transform: 'translateY(0)' },
                        },
                        shimmer: {
                            '0%': { backgroundPosition: '200% 0' },
                            '100%': { backgroundPosition: '-200% 0' },
                        }
                    }
                }
            }
        }
    </script>
    <style type="text/tailwindcss">
        html {
            scroll-padding-top: 2rem; /* Adjust as needed */
        }
        @layer utilities {
            .progress-bar {
                @apply relative overflow-hidden absolute bottom-0 left-0 h-1.5 bg-gradient-to-r from-primary-500 to-primary-700 transition-all duration-1000 ease-linear;
            }
            .progress-bar::after {
                content: '';
                @apply absolute top-0 left-0 w-full h-full;
                background: linear-gradient(90deg, 
                    rgba(255,255,255,0) 0%, rgba(255,255,255,0) 25%,
                    rgba(255,255,255,0.4) 50%, 
                    rgba(255,255,255,0) 75%, rgba(255,255,255,0) 100%
                );
                background-size: 200% 100%;
                animation: shimmer 2.5s infinite linear;
            }
        }
    </style>
</head>
<body class="h-full bg-gray-100 dark:bg-gray-900 transition-colors duration-200">
    <div class="min-h-full">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-5 sm:py-6">
            <!-- Header -->
            <div class="flex justify-between items-center mb-6 sm:mb-8 animate-fadeInUp" style="opacity:0;">
                <h1 class="text-2xl font-bold uppercase text-gray-900 dark:text-white flex items-center" id="page-title">
                    <i class="fas fa-bus mr-3"></i>
                    <span>ROUTE 7</span>
                </h1>
                <div class="flex items-center space-x-3">
                    <button id="open-search-button" aria-label="Open Search" class="p-2.5 rounded-lg bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-gray-200 hover:bg-gray-300 dark:hover:bg-gray-600 transition-colors">
                        <i class="fas fa-search fa-fw"></i>
                    </button>
                    <button id="darkModeToggle" aria-label="Toggle Dark Mode" class="p-2.5 rounded-lg bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-gray-200 hover:bg-gray-300 dark:hover:bg-gray-600 transition-colors">
                        <i class="fas fa-moon fa-fw dark:hidden"></i>
                        <i class="fas fa-sun fa-fw hidden dark:block"></i>
                    </button>
                </div>
            </div>

            <!-- Current Time -->
            <div class="bg-white dark:bg-gray-800 rounded-lg shadow-sm p-4 mb-5 animate-fadeInUp" style="animation-delay: 0.1s; opacity:0;">
                <div class="text-center">
                    <div class="text-sm uppercase tracking-wider text-gray-500 dark:text-gray-400">Current Time (Dubai)</div>
                    <div id="current-time" class="text-3xl font-semibold text-gray-900 dark:text-white mt-1">--:--</div>
                </div>
            </div>

            <!-- Direction Controls -->
            <div class="bg-white dark:bg-gray-800 rounded-lg shadow-sm p-4 mb-4 animate-fadeInUp" style="animation-delay: 0.2s; opacity:0;">
                <div class="flex flex-col sm:flex-row justify-between items-center gap-4">
                    <div class="flex w-full sm:w-auto">
                        <div class="flex rounded-md shadow-sm w-full sm:w-auto" role="group">
                            <button type="button" class="route-tab active uppercase px-4 py-2.5 text-sm font-medium rounded-l-md border border-gray-200 dark:border-gray-700 bg-primary-50 dark:bg-primary-700 text-primary-700 dark:text-white hover:bg-primary-100 dark:hover:bg-primary-600 focus:z-10 focus:ring-2 focus:ring-primary-500" data-direction="pzv2_to_hq">
                                <i class="fas fa-bus mr-2"></i>PZV2 → HQ
                            </button>
                            <button type="button" class="route-tab uppercase px-4 py-2.5 text-sm font-medium rounded-r-md border border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-800 text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700 focus:z-10 focus:ring-2 focus:ring-primary-500" data-direction="hq_to_pzv2">
                                <i class="fas fa-bus mr-2"></i>HQ → PZV2
                            </button>
                        </div>
                    </div>
                    <button id="toggleSchedule" class="inline-flex uppercase items-center px-4 py-2.5 border border-transparent text-xs font-semibold tracking-wider rounded-md text-white bg-primary-600 hover:bg-primary-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500 transition-colors w-full sm:w-auto">
                        <i class="fas fa-calendar-alt mr-2"></i>
                        <span>Show Full Schedule</span>
                    </button>
                </div>
            </div>

            <!-- Next Buses -->
            <div class="mb-5 animate-fadeInUp" style="animation-delay: 0.3s; opacity:0;">
                <h2 class="text-lg uppercase font-semibold tracking-wider text-gray-900 dark:text-white mb-4">Next Departures</h2>
                <div id="next-buses" class="space-y-3 sm:space-y-4">
                     <div class="text-gray-500 dark:text-gray-400 p-4 text-center">Loading schedule...</div>
                </div>
            </div>

            <!-- Full Schedule -->
            <div id="full-schedule" class="opacity-0 transition-all duration-500 ease-in-out max-h-0 overflow-hidden scroll-mt-4">
                <div class="bg-white dark:bg-gray-800 rounded-lg shadow-sm p-4 mb-6">
                    <h2 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">Full Schedule</h2>
                    <div id="schedule-list" class="space-y-2">
                        <!-- Schedule entries populated by JS -->
                    </div>
                </div>
            </div>

            <!-- Search Overlay -->
            <div id="search-overlay" class="hidden fixed inset-0 bg-gray-100/80 dark:bg-gray-900/80 backdrop-blur-sm z-50 p-4 sm:p-6 lg:p-8 animate-slideDownFadeIn">
                <div class="relative bg-white dark:bg-gray-800 rounded-lg shadow-xl max-w-xl mx-auto p-6 mt-10">
                    <button id="close-search-button" aria-label="Close Search" class="absolute top-4 right-4 p-1 rounded-full text-gray-500 dark:text-gray-400 hover:bg-gray-200 dark:hover:bg-gray-700 focus:outline-none">
                        <i class="fas fa-times fa-lg"></i>
                    </button>
                    <h2 class="text-lg uppercase font-semibold text-gray-900 dark:text-white mb-4">Find Bus Before Arrival Time</h2>
                    <div class="flex flex-col sm:flex-row items-end gap-4">
                        <div class="flex-grow w-full">
                            <label for="arrival-time-search" class="block text-sm font-medium uppercase text-gray-700 dark:text-gray-300 mb-1">Desired Arrival Time (PZV2 → HQ Only):</label>
                            <input type="time" id="arrival-time-search" name="arrival-time-search" class="block w-full rounded-md border-gray-300 dark:border-gray-600 shadow-sm focus:border-primary-500 focus:ring-primary-500 sm:text-sm dark:bg-gray-700 dark:text-white p-2">
                        </div>
                        <button id="search-button" type="button" class="inline-flex uppercase items-center justify-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-primary-600 hover:bg-primary-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500 transition-colors w-full sm:w-auto">
                            <i class="fas fa-search mr-2"></i> Search
                        </button>
                    </div>
                    <div id="search-results" class="mt-4 space-y-3">
                        <!-- Search results appear here -->
                    </div>
                </div>
            </div>

        </div> <!-- /max-w container -->
    </div> <!-- /min-h-full -->

    <!-- =================== JAVASCRIPT =================== -->
    <script>
        // --- Global State & Constants ---
        const pzv2Coords = { lat: 25.24014157306891, lon: 55.29637545172292 };
        const hqCoords = { lat: 25.241891643659287, lon: 55.36597152473545 };
        const PROGRESS_WINDOW_MS = 30 * 60 * 1000; // 30 minutes
        const csvUrl = 'route-7-eghq-pzv1-pzv2-eghq-eff-08-september.csv';
        let pzv2_to_hq = [];
        let hq_to_pzv2 = [];
        let scheduleLoaded = false;
        let updateIntervalId = null; // To store the interval ID

        // --- DOM Elements --- 
        const currentTimeEl = document.getElementById('current-time');
        const nextBusesContainer = document.getElementById('next-buses');
        const scheduleListContainer = document.getElementById('schedule-list');
        const fullScheduleContainer = document.getElementById('full-schedule');
        const toggleScheduleButton = document.getElementById('toggleSchedule');
        const searchOverlay = document.getElementById('search-overlay');
        const openSearchButton = document.getElementById('open-search-button');
        const closeSearchButton = document.getElementById('close-search-button');
        const searchButton = document.getElementById('search-button');
        const searchInput = document.getElementById('arrival-time-search');
        const searchResultsContainer = document.getElementById('search-results');
        const darkModeToggleButton = document.getElementById('darkModeToggle');
        const routeTabs = document.querySelectorAll('.route-tab');

        // --- Helper Functions ---
        function getNowInDubaiTimezone() {
            const now = new Date();
            const dubaiOffset = 4 * 60; // GMT+4
            const localOffset = now.getTimezoneOffset();
            const offsetDiff = dubaiOffset + localOffset;
            return new Date(now.getTime() + offsetDiff * 60000);
        }

        function formatTime(date) {
            return date.toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit', hourCycle: 'h23' });
        }

        function formatCountdown(milliseconds) {
            const totalSeconds = Math.max(0, Math.floor(milliseconds / 1000));
            const hours = Math.floor(totalSeconds / 3600);
            const minutes = Math.floor((totalSeconds % 3600) / 60);
            const seconds = totalSeconds % 60;
            if (hours > 0) return `${hours}h ${minutes}m ${seconds}s`;
            if (minutes > 0) return `${minutes}m ${seconds}s`;
            return `${seconds}s`;
        }

        function calculateTravelTime(departTimeStr, arriveTimeStr) {
            try {
                 const [depH, depM] = departTimeStr.split(':').map(Number);
                 const [arrH, arrM] = arriveTimeStr.split(':').map(Number);
                 if ([depH, depM, arrH, arrM].some(isNaN)) return NaN; // Invalid input
                 let totalMinutes = (arrH * 60 + arrM) - (depH * 60 + depM);
                 if (totalMinutes < 0) totalMinutes += 24 * 60; // Handles next day arrival
                 return totalMinutes;
            } catch { return NaN; }
        }

        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371; // km
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                      Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                      Math.sin(dLon / 2) * Math.sin(dLon / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            return R * c;
        }

        // --- Core Logic ---
        async function loadSchedule() {
            try {
                const response = await fetch(csvUrl + `?t=${Date.now()}`); // Cache bust
                if (!response.ok) throw new Error(`HTTP ${response.status} fetching CSV`);
                const csvText = await response.text();
                const lines = csvText.trim().split('\n').slice(2);
                const temp_pzv2_to_hq = [];
                const temp_hq_to_pzv2 = [];

                lines.forEach(line => {
                    const columns = line.trim().split(',');
                    if (columns.length === 4) {
                        const [hqDeparture, , pzv2, hqArrival] = columns;
                        if (hqDeparture && pzv2) temp_hq_to_pzv2.push({ departHQ: hqDeparture, arrivePZV2: pzv2 });
                        if (pzv2 && hqArrival) temp_pzv2_to_hq.push({ departPZV2: pzv2, arriveHQ: hqArrival });
                    }
                });
                
                if (temp_pzv2_to_hq.length === 0 && temp_hq_to_pzv2.length === 0) {
                    throw new Error("CSV parsing resulted in empty schedules");
                }
                
                pzv2_to_hq = temp_pzv2_to_hq;
                hq_to_pzv2 = temp_hq_to_pzv2;
                console.log("Schedule loaded & parsed successfully.");
                scheduleLoaded = true;
            } catch (error) {
                console.error("Schedule Load/Parse Error:", error);
                if (nextBusesContainer) nextBusesContainer.innerHTML = `<div class="text-red-600 dark:text-red-400 p-4 bg-red-100 dark:bg-red-900 rounded-md text-center">Failed to load schedule data. Please check connection or CSV file.</div>`;
                scheduleLoaded = false;
            }
        }

        function updateDisplay() {
            if (!scheduleLoaded) {
                 if (nextBusesContainer && !nextBusesContainer.querySelector('.text-red-600')) {
                    nextBusesContainer.innerHTML = `<div class="text-gray-500 dark:text-gray-400 p-4 text-center">Loading schedule...</div>`;
                 }
                 return;
            }
            
            const now = getNowInDubaiTimezone();
            if (currentTimeEl) currentTimeEl.textContent = formatTime(now);

            const activeTab = document.querySelector('.route-tab.active');
            if (!activeTab) return; // Should not happen
            const direction = activeTab.dataset.direction;
            const schedule = direction === 'pzv2_to_hq' ? pzv2_to_hq : hq_to_pzv2;
            
            if (!nextBusesContainer) return;
            nextBusesContainer.innerHTML = ''; // Clear previous entries

            if (!schedule || schedule.length === 0) {
                nextBusesContainer.innerHTML = `<div class="text-yellow-600 dark:text-yellow-400 p-4 bg-yellow-100 dark:bg-yellow-900 rounded-md text-center">Schedule data unavailable for this direction.</div>`;
                return;
            }

            // --- Find Next Departures --- 
            const potentialDepartures = [];
            const today = new Date(now); today.setSeconds(0,0);
            const tomorrow = new Date(now); tomorrow.setDate(now.getDate() + 1); tomorrow.setSeconds(0,0);

            schedule.forEach(entry => {
                if (!entry) return;
                const departTimeStr = direction === 'pzv2_to_hq' ? entry.departPZV2 : entry.departHQ;
                const arriveTimeStr = direction === 'pzv2_to_hq' ? entry.arriveHQ : entry.arrivePZV2;
                if (!departTimeStr || !arriveTimeStr) return;
                const [hours, minutes] = departTimeStr.split(':').map(Number);
                if (isNaN(hours) || isNaN(minutes)) return;

                const todayDeparture = new Date(today); todayDeparture.setHours(hours, minutes);
                const tomorrowDeparture = new Date(tomorrow); tomorrowDeparture.setHours(hours, minutes);
                
                if (todayDeparture > now) potentialDepartures.push({ departTime: todayDeparture, arriveTime: arriveTimeStr, isTomorrow: false });
                potentialDepartures.push({ departTime: tomorrowDeparture, arriveTime: arriveTimeStr, isTomorrow: true });
            });
            
            potentialDepartures.sort((a, b) => a.departTime - b.departTime);
            const nextThree = potentialDepartures.slice(0, 3);

            if (nextThree.length === 0) {
                nextBusesContainer.innerHTML = `<div class="text-gray-500 dark:text-gray-400 p-4 text-center">No upcoming departures found.</div>`;
                return;
            }

            // --- Display Next Buses --- 
            nextThree.forEach((bus, index) => {
                const isNext = index === 0;
                const countdown = bus.departTime - now;
                const progress = isNext ? Math.max(0, Math.min(100, (countdown / PROGRESS_WINDOW_MS) * 100)) : 0;
                const travelMinutes = calculateTravelTime(formatTime(bus.departTime), bus.arriveTime);
                
                const busEntry = document.createElement('div');
                busEntry.className = `relative overflow-hidden bg-white dark:bg-gray-800 rounded-lg shadow-sm p-4 ${isNext ? 'ring-2 ring-primary-500 dark:bg-gray-700 dark:ring-primary-500' : 'dark:bg-gray-800'}`;
                
                busEntry.innerHTML = `
                    <div class="flex justify-between items-center mb-3">
                        <div class="text-lg font-semibold text-gray-900 dark:text-white flex items-center">
                            <i class="far fa-clock mr-2 text-gray-500 dark:text-gray-400"></i>
                            <span>${formatTime(bus.departTime)}</span>
                            ${bus.isTomorrow ? '<span class="text-xs font-normal normal-case text-gray-500 dark:text-gray-400 ml-2 pt-1">(Tomorrow)</span>' : ''}
                        </div>
                        <div class="text-sm uppercase text-gray-500 dark:text-gray-400 flex items-center">
                            <i class="fas fa-flag-checkered mr-2"></i>
                            Arrives: ${bus.arriveTime}
                        </div>
                    </div>
                    <div class="text-xs uppercase tracking-wide text-gray-500 dark:text-gray-400 mb-3 flex items-center">
                        <i class="fas fa-hourglass-half mr-2 fa-fw"></i>
                        Travel time: ${isNaN(travelMinutes) ? 'N/A' : travelMinutes + ' min'}
                    </div>
                    <div class="text-base uppercase font-bold text-primary-600 dark:text-primary-400 flex items-center">
                        <i class="fas fa-stopwatch mr-2 fa-fw"></i>
                        Departing in: ${formatCountdown(countdown)}
                    </div>
                `;

                if (isNext) {
                    const progressBar = document.createElement('div');
                    progressBar.className = 'progress-bar';
                    progressBar.style.width = `${progress}%`;
                    busEntry.appendChild(progressBar);
                }
                nextBusesContainer.appendChild(busEntry);
            });
        }

        function selectRouteTab(directionValue) {
            routeTabs.forEach(t => {
                 const tabDirection = t.dataset.direction;
                 t.classList.remove('active', 'bg-primary-50', 'dark:bg-primary-700', 'text-primary-700', 'dark:text-white');
                 t.classList.add('bg-white', 'dark:bg-gray-800', 'text-gray-700', 'dark:text-gray-300');
                 if (tabDirection === directionValue) {
                     t.classList.remove('bg-white', 'dark:bg-gray-800', 'text-gray-700', 'dark:text-gray-300');
                     t.classList.add('active', 'bg-primary-50', 'dark:bg-primary-700', 'text-primary-700', 'dark:text-white'); 
                 }
             });
             updateDisplay();
        }

        function startUpdateInterval() {
             if (updateIntervalId) clearInterval(updateIntervalId); // Clear existing interval if any
             updateIntervalId = setInterval(updateDisplay, 1000);
             console.log("Update interval started.");
        }
        
        // --- Event Listeners ---
        if (darkModeToggleButton) {
            darkModeToggleButton.addEventListener('click', () => {
                document.documentElement.classList.toggle('dark');
                localStorage.theme = document.documentElement.classList.contains('dark') ? 'dark' : 'light';
            });
        }
        
        if (openSearchButton && closeSearchButton && searchOverlay) {
            openSearchButton.addEventListener('click', () => searchOverlay.classList.remove('hidden'));
            closeSearchButton.addEventListener('click', () => searchOverlay.classList.add('hidden'));
            searchOverlay.addEventListener('click', (event) => { 
                 if (event.target === searchOverlay) searchOverlay.classList.add('hidden'); 
            });
        }
        
        if (searchButton && searchInput && searchResultsContainer) {
            searchButton.addEventListener('click', () => {
                if (!scheduleLoaded) {
                    searchResultsContainer.innerHTML = `<p class="text-yellow-600 dark:text-yellow-400">Schedule loading...</p>`;
                    return;
                }
                const direction = document.querySelector('.route-tab.active')?.dataset.direction;
                if (direction !== 'pzv2_to_hq') {
                    searchResultsContainer.innerHTML = `<p class="text-yellow-600 dark:text-yellow-400">Arrival search only for PZV2 → HQ.</p>`;
                    return; 
                }
                
                const desiredTime = searchInput.value;
                searchResultsContainer.innerHTML = '';
                if (!desiredTime) {
                    searchResultsContainer.innerHTML = `<p class="text-red-600 dark:text-red-400">Enter arrival time.</p>`;
                    return;
                }
                
                try {
                    const now = getNowInDubaiTimezone();
                    const [targetH, targetM] = desiredTime.split(':').map(Number);
                    if (isNaN(targetH) || isNaN(targetM)) throw new Error("Invalid time format");
                    const targetDate = new Date(now); targetDate.setHours(targetH, targetM, 0, 0);
                    
                    const relevantTrips = pzv2_to_hq.map(trip => {
                        const [arrH, arrM] = trip.arriveHQ.split(':').map(Number);
                        if (isNaN(arrH) || isNaN(arrM)) return null;
                        const arrivalDate = new Date(now); arrivalDate.setHours(arrH, arrM, 0, 0);
                        return arrivalDate <= targetDate ? { ...trip, arrivalDateTime: arrivalDate } : null;
                    }).filter(Boolean);
                    
                    relevantTrips.sort((a, b) => b.arrivalDateTime - a.arrivalDateTime);
                    const results = relevantTrips.slice(0, 5);
                    
                    if (results.length === 0) {
                         searchResultsContainer.innerHTML = `<p class="text-gray-600 dark:text-gray-400">No buses arrive at HQ by ${desiredTime} today.</p>`;
                    } else {
                        searchResultsContainer.innerHTML = `<h3 class="text-md uppercase font-semibold text-gray-800 dark:text-gray-200 mb-2">Latest arriving at HQ by ${desiredTime} (up to 5):</h3>`;
                        results.forEach(trip => {
                            const travelMinutes = calculateTravelTime(trip.departPZV2, trip.arriveHQ);
                            const tripEl = document.createElement('div');
                            tripEl.className = 'bg-white dark:bg-gray-800 p-3 rounded-md shadow-sm text-sm';
                            tripEl.innerHTML = `
                                <div class="flex justify-between items-center mb-1">
                                    <span class="text-gray-700 dark:text-gray-300"><i class="fas fa-clock text-gray-500 dark:text-gray-400 mr-1"></i> Departs PZV2: <strong class="text-gray-900 dark:text-white">${trip.departPZV2}</strong></span>
                                    <span class="text-gray-700 dark:text-gray-300"><i class="fas fa-flag-checkered text-gray-500 dark:text-gray-400 mr-1"></i> Arrives HQ: <strong class="text-gray-900 dark:text-white">${trip.arriveHQ}</strong></span>
                                </div>
                                <div class="text-xs uppercase text-gray-500 dark:text-gray-400 mt-1"><i class="fas fa-hourglass-half mr-1"></i> Travel Time: ${isNaN(travelMinutes) ? 'N/A' : travelMinutes + ' min'}</div>
                            `;
                            searchResultsContainer.appendChild(tripEl);
                        });
                    }
                } catch (err) {
                    console.error("Search Error:", err);
                    searchResultsContainer.innerHTML = `<p class="text-red-600 dark:text-red-400">Error processing search. Check time format.</p>`;
                }
            });
        }
        
        if (toggleScheduleButton && fullScheduleContainer && scheduleListContainer) {
            toggleScheduleButton.addEventListener('click', function() {
                if (!scheduleLoaded) return;
                const buttonSpan = this.querySelector('span');
                const icon = this.querySelector('i');
                
                if (fullScheduleContainer.style.maxHeight && fullScheduleContainer.style.maxHeight !== '0px') {
                    fullScheduleContainer.style.maxHeight = '0px';
                    fullScheduleContainer.style.opacity = '0';
                    if(buttonSpan) buttonSpan.textContent = 'Show Full Schedule';
                    if(icon) icon.classList.replace('fa-calendar-times', 'fa-calendar-alt');
                } else {
                    scheduleListContainer.innerHTML = ''; // Clear first
                    const direction = document.querySelector('.route-tab.active')?.dataset.direction;
                    const schedule = direction === 'pzv2_to_hq' ? pzv2_to_hq : hq_to_pzv2;
                    if (schedule && schedule.length > 0) {
                        schedule.forEach(entry => {
                            const depart = direction === 'pzv2_to_hq' ? entry.departPZV2 : entry.departHQ;
                            const arrive = direction === 'pzv2_to_hq' ? entry.arriveHQ : entry.arrivePZV2;
                            if (!depart || !arrive) return;
                            const travelMins = calculateTravelTime(depart, arrive);
                            const item = document.createElement('div');
                            item.className = 'flex justify-between items-center py-2 border-b border-gray-200 dark:border-gray-700 last:border-0';
                            item.innerHTML = `
                                <span class="uppercase text-xs tracking-wide text-gray-700 dark:text-gray-300"><i class="fas fa-clock mr-1"></i> ${depart} → ${arrive}</span>
                                <span class="text-xs uppercase text-gray-500 dark:text-gray-400"><i class="fas fa-hourglass-half mr-1"></i> ${isNaN(travelMins) ? 'N/A' : travelMins + ' min'}</span>
                            `;
                            scheduleListContainer.appendChild(item);
                        });
                    } else {
                        scheduleListContainer.innerHTML = '<p class="text-gray-500 dark:text-gray-400 text-sm text-center">Schedule not available.</p>';
                    }
                    fullScheduleContainer.style.opacity = '1';
                    fullScheduleContainer.style.maxHeight = fullScheduleContainer.scrollHeight + 'px';
                    if(buttonSpan) buttonSpan.textContent = 'Hide Full Schedule';
                    if(icon) icon.classList.replace('fa-calendar-alt', 'fa-calendar-times');
                    setTimeout(() => fullScheduleContainer.scrollIntoView({ behavior: 'smooth', block: 'start' }), 100);
                }
            });
        }
        
        routeTabs.forEach(tab => {
            tab.addEventListener('click', () => {
                const clickedDirection = tab.dataset.direction;
                selectRouteTab(clickedDirection);
                // Collapse full schedule when changing route
                if (fullScheduleContainer.style.maxHeight && fullScheduleContainer.style.maxHeight !== '0px') {
                     fullScheduleContainer.style.maxHeight = '0px';
                     fullScheduleContainer.style.opacity = '0';
                     const btnSpan = toggleScheduleButton.querySelector('span');
                     const btnIcon = toggleScheduleButton.querySelector('i');
                     if(btnSpan) btnSpan.textContent = 'Show Full Schedule';
                     if(btnIcon) btnIcon.classList.replace('fa-calendar-times', 'fa-calendar-alt');
                }
            });
        });

        // --- Initialisation --- 
        async function initializeApp() {
            await loadSchedule();
            if (!scheduleLoaded) return;

            if (navigator.geolocation) {
                console.log("Attempting geolocation...");
                navigator.geolocation.getCurrentPosition(
                    (pos) => {
                        const userLat = pos.coords.latitude, userLon = pos.coords.longitude;
                        const distPZV2 = calculateDistance(userLat, userLon, pzv2Coords.lat, pzv2Coords.lon);
                        const distHQ = calculateDistance(userLat, userLon, hqCoords.lat, hqCoords.lon);
                        const direction = (distPZV2 <= distHQ) ? 'pzv2_to_hq' : 'hq_to_pzv2';
                        console.log(`Geolocation success: Closer to ${direction === 'pzv2_to_hq' ? 'PZV2' : 'HQ'}. Setting route.`);
                        selectRouteTab(direction);
                        startUpdateInterval();
                    },
                    (err) => {
                        console.warn(`Geolocation error (${err.code}): ${err.message}. Defaulting route.`);
                        selectRouteTab('pzv2_to_hq'); // Default on error
                        startUpdateInterval();
                    },
                    { timeout: 8000, maximumAge: 300000, enableHighAccuracy: false }
                );
            } else {
                console.warn("Geolocation not supported. Defaulting route.");
                selectRouteTab('pzv2_to_hq'); // Default if no geolocation
                startUpdateInterval();
            }
        }

        initializeApp();
        
        // --- PWA Registration --- 
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('sw.js') // Use relative path
                    .then(reg => console.log('ServiceWorker registered.', reg.scope))
                    .catch(err => console.error('ServiceWorker registration failed:', err));
            });
        }

        // --- Function for Shortcuts App ---
        window.getNextBusInfoForShortcut = function() {
            const nextBusEl = document.querySelector('#next-buses .ring-2'); // Find the highlighted next bus
            if (!nextBusEl) {
                return { error: "Next bus information not available." };
            }

            try {
                const departureTimeEl = nextBusEl.querySelector('.text-lg span');
                const isTomorrowEl = nextBusEl.querySelector('.text-lg .text-xs');
                const arrivalTimeText = nextBusEl.querySelector('.text-sm.uppercase')?.textContent || '';
                const countdownTextEl = nextBusEl.querySelector('.text-base.uppercase');

                const departureTime = departureTimeEl ? departureTimeEl.textContent.trim() : 'N/A';
                const isTomorrow = !!isTomorrowEl; // Check if the (Tomorrow) span exists
                const arrivalTimeMatch = arrivalTimeText.match(/Arrives:\s*(\d{2}:\d{2})/);
                const arrivalTime = arrivalTimeMatch ? arrivalTimeMatch[1] : 'N/A';
                const countdownText = countdownTextEl ? countdownTextEl.textContent.trim() : 'N/A';

                return {
                    departure: departureTime,
                    departureIsTomorrow: isTomorrow,
                    arrival: arrivalTime,
                    countdownText: countdownText
                };
            } catch (e) {
                console.error("Error in getNextBusInfoForShortcut:", e);
                return { error: "Failed to parse bus information." };
            }
        }

    </script>

</body>
</html>