<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Route 7 Bus Times</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <!-- Google Fonts (Quicksand) -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- PWA Support -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#312E81">
    <link rel="icon" type="image/png" href="favicon.png">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="favicon.png">
    <!-- Google Identity Services -->
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script src="https://apis.google.com/js/api.js" async defer></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Quicksand', 'sans-serif'],
                    },
                    colors: {
                        primary: {
                            50: '#EEF2FF',
                            100: '#E0E7FF',
                            500: '#6366F1',
                            600: '#4F46E5',
                            700: '#4338CA',
                            800: '#3730A3',
                            900: '#312E81'
                        },
                        gray: {
                            800: '#1F2937',
                            900: '#111827'
                        }
                    },
                    animation: {
                        'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                    }
                }
            }
        }

        // --- Google API Config --- 
        const CLIENT_ID = "498236670497-dmqp8caege8gld654l2059bncvvss808.apps.googleusercontent.com"; // <-- PASTE YOUR CLIENT ID HERE
        const API_KEY = "AIzaSyCDTAjU5GZssUYNjPOMcQ--fq2n_BZ_oGk"; // <-- Optional, but recommended for API calls - Create an API Key in Google Cloud Credentials
        const CALENDAR_SCOPE = "https://www.googleapis.com/auth/calendar.events.readonly";
        let tokenClient; // For handling authorization tokens
        let gapiInited = false;
        let gisInited = false;

        // --- Existing Config/Vars (Keep these lines commented or remove them) ---
        /* 
        const pzv2Coords = { lat: 25.24014157306891, lon: 55.29637545172292 };
        const hqCoords = { lat: 25.241891643659287, lon: 55.36597152473545 };
        let pzv2_to_hq = [];
        let hq_to_pzv2 = [];
        let scheduleLoaded = false;
        const csvUrl = 'route-7-eghq-pzv1-pzv2-eghq-eff-08-september.csv'; // Relative path
        const PROGRESS_WINDOW_MS = 30 * 60 * 1000; // 30 minutes in milliseconds
        */

    </script>
    <style type="text/tailwindcss">
        html {
            scroll-padding-top: 2rem; /* Add scroll padding to prevent header overlap */
        }
        @layer utilities {
            .progress-bar {
                @apply relative overflow-hidden absolute bottom-0 left-0 h-1.5 bg-gradient-to-r from-primary-500 to-primary-700 transition-all duration-1000 ease-linear;
            }
            .progress-bar::after {
                content: '';
                @apply absolute top-0 left-0 w-full h-full;
                background: linear-gradient(90deg, 
                    rgba(255,255,255,0) 0%, 
                    rgba(255,255,255,0) 25%,
                    rgba(255,255,255,0.4) 50%,
                    rgba(255,255,255,0) 75%,
                    rgba(255,255,255,0) 100%
                );
                background-size: 200% 100%;
                animation: shimmer 2.5s infinite linear;
            }
        }
        @keyframes shimmer {
            0% { background-position: 200% 0; } 
            100% { background-position: -200% 0; }
        }
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        @keyframes slideDownFadeIn {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
    </style>
</head>
<body class="h-full bg-gray-100 dark:bg-gray-900 transition-colors duration-200">
    <div class="min-h-full">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-5 sm:py-6">
            <!-- Header -->
            <div class="flex justify-between items-center mb-6 sm:mb-8" style="animation: fadeInUp 0.5s ease-out forwards;">
                <h1 class="text-2xl font-bold uppercase text-gray-900 dark:text-white flex items-center" id="page-title">
                    <i class="fas fa-bus mr-3"></i>
                    <span>ROUTE 7</span>
                </h1>
                <div class="flex items-center space-x-3">
                    <button id="open-search-button" class="p-2.5 rounded-lg bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-gray-200 hover:bg-gray-300 dark:hover:bg-gray-600 transition-colors">
                        <i class="fas fa-search fa-fw"></i>
                    </button>
                    <button id="darkModeToggle" class="p-2.5 rounded-lg bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-gray-200 hover:bg-gray-300 dark:hover:bg-gray-600 transition-colors">
                        <i class="fas fa-moon fa-fw dark:hidden"></i>
                        <i class="fas fa-sun fa-fw hidden dark:block"></i>
                    </button>
                </div>
            </div>

            <!-- Google Calendar Integration -->
            <div class="bg-white dark:bg-gray-800 rounded-lg shadow-sm p-4 mb-4" style="animation: fadeInUp 0.5s 0.05s ease-out forwards; opacity: 0;">
                <div class="flex flex-col sm:flex-row items-center gap-3">
                    <button id="authorize_button" disabled class="inline-flex items-center justify-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 disabled:opacity-50 disabled:cursor-not-allowed">
                        <i class="fab fa-google mr-2"></i> <span>Sign In & Authorize Calendar</span>
                    </button>
                    <button id="fetch_event_button" disabled class="inline-flex items-center justify-center px-4 py-2 border border-gray-300 dark:border-gray-600 text-sm font-medium rounded-md text-gray-700 dark:text-gray-200 bg-white dark:bg-gray-700 hover:bg-gray-50 dark:hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 disabled:opacity-50 disabled:cursor-not-allowed">
                        <i class="fas fa-calendar-day mr-2"></i> Fetch Next Event
                    </button>
                    <div id="auth_status" class="text-xs text-gray-500 dark:text-gray-400 sm:ml-auto"></div>
                </div>
            </div>

            <!-- Current Time -->
            <div class="bg-white dark:bg-gray-800 rounded-lg shadow-sm p-4 mb-5" style="animation: fadeInUp 0.5s 0.1s ease-out forwards; opacity: 0;">
                <div class="text-center">
                    <div class="text-sm uppercase tracking-wider text-gray-500 dark:text-gray-400">Current Time (Dubai)</div>
                    <div id="current-time" class="text-3xl font-semibold text-gray-900 dark:text-white mt-1"></div>
                </div>
            </div>

            <!-- Direction Controls -->
            <div class="bg-white dark:bg-gray-800 rounded-lg shadow-sm p-4 mb-4" style="animation: fadeInUp 0.5s 0.2s ease-out forwards; opacity: 0;">
                <div class="flex flex-col sm:flex-row justify-between items-center gap-4">
                    <div class="flex w-full sm:w-auto">
                        <div class="flex rounded-md shadow-sm w-full sm:w-auto" role="group">
                            <button type="button" 
                                class="route-tab active uppercase px-4 py-2.5 text-sm font-medium rounded-l-md border border-gray-200 dark:border-gray-700 bg-primary-50 dark:bg-primary-700 text-primary-700 dark:text-white hover:bg-primary-100 dark:hover:bg-primary-600 focus:z-10 focus:ring-2 focus:ring-primary-500"
                                data-direction="pzv2_to_hq">
                                <i class="fas fa-bus mr-2"></i>PZV2 → HQ
                            </button>
                            <button type="button" 
                                class="route-tab uppercase px-4 py-2.5 text-sm font-medium rounded-r-md border border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-800 text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700 focus:z-10 focus:ring-2 focus:ring-primary-500"
                                data-direction="hq_to_pzv2">
                                <i class="fas fa-bus mr-2"></i>HQ → PZV2
                            </button>
                        </div>
                    </div>
                    <button id="toggleSchedule"
                        class="inline-flex uppercase items-center px-4 py-2.5 border border-transparent text-xs font-semibold tracking-wider rounded-md text-white bg-primary-600 hover:bg-primary-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500 transition-colors w-full sm:w-auto">
                        <i class="fas fa-calendar-alt mr-2"></i>
                        <span>Show Full Schedule</span>
                    </button>
                </div>
            </div>

            <!-- Next Buses -->
            <div class="mb-5" style="animation: fadeInUp 0.5s 0.3s ease-out forwards; opacity: 0;">
                <h2 class="text-lg uppercase font-semibold tracking-wider text-gray-900 dark:text-white mb-4">Next Departures</h2>
                <div id="next-buses" class="space-y-3 sm:space-y-4">
                    <!-- Bus entries will be inserted here -->
                </div>
            </div>

            <!-- Full Schedule -->
            <div id="full-schedule" class="opacity-0 transition-all duration-500 ease-in-out max-h-0 overflow-hidden scroll-mt-4">
                <div class="bg-white dark:bg-gray-800 rounded-lg shadow-sm p-4 mb-6">
                    <h2 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">Full Schedule</h2>
                    <div id="schedule-list" class="space-y-2">
                        <!-- Schedule entries will be inserted here -->
                    </div>
                </div>
            </div>

            <!-- Search Overlay (New) -->
            <div id="search-overlay" 
                 class="hidden fixed inset-0 bg-gray-100/80 dark:bg-gray-900/80 backdrop-blur-sm z-50 p-4 sm:p-6 lg:p-8 transition-opacity duration-300 ease-in-out" 
                 style="animation: slideDownFadeIn 0.3s ease-out forwards;">
                <div class="relative bg-white dark:bg-gray-800 rounded-lg shadow-xl max-w-xl mx-auto p-6 mt-10">
                    <button id="close-search-button" class="absolute top-4 right-4 p-1 rounded-full text-gray-500 dark:text-gray-400 hover:bg-gray-200 dark:hover:bg-gray-700 focus:outline-none">
                        <i class="fas fa-times fa-lg"></i>
                    </button>
                    <h2 class="text-lg uppercase font-semibold text-gray-900 dark:text-white mb-4">Find Bus Before Arrival Time</h2>
                    <div class="flex flex-col sm:flex-row items-end gap-4">
                        <div class="flex-grow w-full">
                            <label for="arrival-time-search" class="block text-sm font-medium uppercase text-gray-700 dark:text-gray-300 mb-1">Desired Arrival Time:</label>
                            <input type="time" id="arrival-time-search" name="arrival-time-search"
                                   class="block w-full rounded-md border-gray-300 dark:border-gray-600 shadow-sm focus:border-primary-500 focus:ring-primary-500 sm:text-sm dark:bg-gray-700 dark:text-white p-2">
                        </div>
                        <button id="search-button"
                                class="inline-flex uppercase items-center justify-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-primary-600 hover:bg-primary-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500 transition-colors w-full sm:w-auto">
                            <i class="fas fa-search mr-2"></i> Search
                        </button>
                    </div>
                    <div id="search-results" class="mt-4 space-y-3">
                        <!-- Search results will appear here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Dark mode toggle
        const darkModeToggle = document.getElementById('darkModeToggle');
        if (localStorage.theme === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
            document.documentElement.classList.add('dark');
        } else {
            document.documentElement.classList.remove('dark');
        }

        darkModeToggle.addEventListener('click', () => {
            document.documentElement.classList.toggle('dark');
            localStorage.theme = document.documentElement.classList.contains('dark') ? 'dark' : 'light';
        });

        // Search Bar Toggle Logic
        const openSearchButton = document.getElementById('open-search-button');
        const closeSearchButton = document.getElementById('close-search-button');
        const searchOverlay = document.getElementById('search-overlay');

        if (openSearchButton && closeSearchButton && searchOverlay) {
            openSearchButton.addEventListener('click', () => {
                searchOverlay.classList.remove('hidden');
            });

            closeSearchButton.addEventListener('click', () => {
                searchOverlay.classList.add('hidden');
            });

            // Add event listener to close overlay when clicking outside the content box
            searchOverlay.addEventListener('click', (event) => {
                // Check if the click is directly on the overlay background itself
                if (event.target === searchOverlay) {
                    searchOverlay.classList.add('hidden');
                }
            });
        } else {
            console.error("Search toggle buttons or overlay not found!");
        }

        // --- Coordinates ---
        const pzv2Coords = { lat: 25.24014157306891, lon: 55.29637545172292 };
        const hqCoords = { lat: 25.241891643659287, lon: 55.36597152473545 };

        // --- Schedule Data (will be loaded dynamically) ---
        let pzv2_to_hq = [];
        let hq_to_pzv2 = [];
        let scheduleLoaded = false;
        const csvUrl = 'route-7-eghq-pzv1-pzv2-eghq-eff-08-september.csv'; // Relative path
        const PROGRESS_WINDOW_MS = 30 * 60 * 1000; // 30 minutes in milliseconds

        // --- Helper Functions ---
        function getNowInDubaiTimezone() {
            const now = new Date();
            const dubaiOffset = 4 * 60; // Dubai is GMT+4
            const localOffset = now.getTimezoneOffset();
            const offsetDiff = dubaiOffset + localOffset;
            return new Date(now.getTime() + offsetDiff * 60000);
        }

        function formatTime(date) {
            return date.toLocaleTimeString('en-GB', {
                hour: '2-digit',
                minute: '2-digit',
                hourCycle: 'h23'
            });
        }

        function formatCountdown(milliseconds) {
            const totalSeconds = Math.floor(milliseconds / 1000);
            const hours = Math.floor(totalSeconds / 3600);
            const minutes = Math.floor((totalSeconds % 3600) / 60);
            const seconds = totalSeconds % 60;

            if (hours > 0) {
                return `${hours}h ${minutes}m ${seconds}s`;
            } else if (minutes > 0) {
                return `${minutes}m ${seconds}s`;
            } else {
                return `${seconds}s`;
            }
        }

        function calculateTravelTime(departTime, arriveTime) {
            const [departHours, departMinutes] = departTime.split(':').map(Number);
            const [arriveHours, arriveMinutes] = arriveTime.split(':').map(Number);
            
            let totalMinutes = (arriveHours * 60 + arriveMinutes) - (departHours * 60 + departMinutes);
            if (totalMinutes < 0) {
                totalMinutes += 24 * 60; // Add 24 hours if arrival is next day
            }
            
            return totalMinutes;
        }

        // --- Haversine Distance Calculation ---
        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371; // Radius of the Earth in km
            const dLat = deg2rad(lat2 - lat1);
            const dLon = deg2rad(lon2 - lon1);
            const a =
                Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                Math.cos(deg2rad(lat1)) * Math.cos(deg2rad(lat2)) *
                Math.sin(dLon / 2) * Math.sin(dLon / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            const d = R * c; // Distance in km
            return d;
        }

        function deg2rad(deg) {
            return deg * (Math.PI / 180);
        }

        // --- Function to Load and Parse Schedule ---
        async function loadSchedule() {
            try {
                const response = await fetch(csvUrl);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status} while fetching ${csvUrl}`);
                }
                const csvText = await response.text();
                
                // Parse CSV
                const lines = csvText.trim().split('\n'); // Split into lines
                // Skip header rows (assuming first 2 rows are headers)
                const dataLines = lines.slice(2); 

                pzv2_to_hq = []; // Clear any previous data
                hq_to_pzv2 = []; // Clear any previous data

                dataLines.forEach(line => {
                    const columns = line.trim().split(',');
                    if (columns.length === 4) { // Ensure valid row
                        const hqDeparture = columns[0];
                        const pzv1 = columns[1]; // Not used currently, but parsed
                        const pzv2 = columns[2];
                        const hqArrival = columns[3];

                        // Populate HQ -> PZV2 schedule
                        if (hqDeparture && pzv2) {
                             hq_to_pzv2.push({ departHQ: hqDeparture, arrivePZV2: pzv2 });
                        }
                       
                        // Populate PZV2 -> HQ schedule
                        if (pzv2 && hqArrival) {
                            pzv2_to_hq.push({ departPZV2: pzv2, arriveHQ: hqArrival });
                        }
                    }
                });
                
                console.log("Schedule loaded and parsed successfully.");
                scheduleLoaded = true;

            } catch (error) {
                console.error("Failed to load or parse schedule:", error);
                // Display an error message to the user on the page
                 document.getElementById('next-buses').innerHTML = `<div class="text-red-600 dark:text-red-400 p-4 bg-red-100 dark:bg-red-900 rounded-md">Error loading bus schedule. Please check the CSV file or network connection.</div>`;
                scheduleLoaded = false; // Ensure we know loading failed
            }
        }

        // --- Function to Programmatically Select Route Tab ---
        function selectRouteTab(directionValue) {
             console.log(`Programmatically selecting tab: ${directionValue}`);
             document.querySelectorAll('.route-tab').forEach(t => {
                 const tabDirection = t.dataset.direction;
                 // Remove active classes (generic)
                 t.classList.remove('active', 
                                  'bg-primary-50', 'dark:bg-primary-700', 'dark:bg-primary-900', // Remove old dark bg possibilities 
                                  'text-primary-700', 'dark:text-white', 'dark:text-primary-300'); // Remove old dark text possibilities
                 // Add default inactive classes
                 t.classList.add('bg-white', 'dark:bg-gray-800', 'text-gray-700', 'dark:text-gray-300');
                 
                 // Apply active classes to the target tab
                 if (tabDirection === directionValue) {
                     t.classList.remove('bg-white', 'dark:bg-gray-800', 'text-gray-700', 'dark:text-gray-300');
                     // Apply NEW active styles
                     t.classList.add('active', 'bg-primary-50', 'dark:bg-primary-700', 'text-primary-700', 'dark:text-white'); 
                 }
             });
             // Update display immediately after changing the tab state
             updateDisplay();
        }

         // --- Function to start the regular update interval ---
         function startUpdateInterval() {
             console.log("Starting update interval.");
             setInterval(updateDisplay, 1000); 
         }

        // --- Update Display (needs scheduleLoaded check) ---
        function updateDisplay() {
            if (!scheduleLoaded) {
                // Maybe show a loading indicator or wait message if not already showing error
                console.log("Waiting for schedule to load...");
                // Ensure loading message persists if needed
                if (!document.getElementById('next-buses').querySelector('.text-red-600')) {
                    document.getElementById('next-buses').innerHTML = `<div class="text-gray-500 dark:text-gray-400 p-4">Loading schedule...</div>`;
                }
                return; 
            }
            
            const now = getNowInDubaiTimezone();
            const currentTimeStr = formatTime(now);
            document.getElementById('current-time').textContent = currentTimeStr;

            const direction = document.querySelector('.route-tab.active').dataset.direction;
            // Use the globally loaded schedule data
            const schedule = direction === 'pzv2_to_hq' ? pzv2_to_hq : hq_to_pzv2; 
            const nextBusesContainer = document.getElementById('next-buses');
            
            nextBusesContainer.innerHTML = ''; // Clear only next buses here

            if (!schedule || schedule.length === 0) {
                 nextBusesContainer.innerHTML = `<div class="text-yellow-600 dark:text-yellow-400 p-4 bg-yellow-100 dark:bg-yellow-900 rounded-md">Schedule data is empty or invalid for this direction.</div>`;
                 return; // Stop processing if schedule is empty
            }

            // Find next three departures
            const potentialDepartures = [];
            const today = new Date(now);
            const tomorrow = new Date(now);
            tomorrow.setDate(tomorrow.getDate() + 1);

            schedule.forEach(entry => {
                // Defensive check for entry structure
                if (!entry) return;
                const departTime = direction === 'pzv2_to_hq' ? entry.departPZV2 : entry.departHQ;
                const arriveTime = direction === 'pzv2_to_hq' ? entry.arriveHQ : entry.arrivePZV2;
                
                // Ensure times exist before proceeding
                if (!departTime || !arriveTime) {
                    console.warn("Skipping schedule entry with missing times:", entry);
                    return;
                }

                // Create Date objects for today and tomorrow
                const [hours, minutes] = departTime.split(':').map(Number);
                
                 // Validate parsed times
                if (isNaN(hours) || isNaN(minutes) || hours < 0 || hours > 23 || minutes < 0 || minutes > 59) {
                    console.warn("Skipping schedule entry with invalid depart time format:", entry);
                    return;
                }

                const todayDeparture = new Date(today);
                todayDeparture.setHours(hours, minutes, 0, 0);
                
                const tomorrowDeparture = new Date(tomorrow);
                tomorrowDeparture.setHours(hours, minutes, 0, 0);

                if (todayDeparture > now) {
                    potentialDepartures.push({
                        departTime: todayDeparture,
                        arriveTime: arriveTime,
                        isTomorrow: false
                    });
                }

                potentialDepartures.push({
                    departTime: tomorrowDeparture,
                    arriveTime: arriveTime,
                    isTomorrow: true
                });
            });

            // Sort by departure time and take next three
            potentialDepartures.sort((a, b) => a.departTime - b.departTime);

            // Create a sorted list of all future departure Date objects for progress calculation
            const allFutureDepartures = potentialDepartures.map(p => p.departTime);

            const nextThree = potentialDepartures.slice(0, 3);
            
             // Handle case where no future buses are found (e.g., end of day before schedule wraps)
            if (nextThree.length === 0) {
                 nextBusesContainer.innerHTML = `<div class="text-gray-500 dark:text-gray-400 p-4">No upcoming departures found for today/tomorrow.</div>`;
            }

            // Display next buses
            nextThree.forEach((bus, index) => {
                const isNext = index === 0;
                const countdown = bus.departTime - now; // Time remaining in ms
                
                let progress = 0;
                if (isNext) {
                    // Option 1: % of fixed window remaining
                    progress = Math.max(0, Math.min(100, (countdown / PROGRESS_WINDOW_MS) * 100));
                }

                const busEntry = document.createElement('div');
                busEntry.className = `relative overflow-hidden bg-white dark:bg-gray-800 rounded-lg shadow-sm p-4 ${isNext ? 'ring-2 ring-primary-500 dark:bg-gray-700 dark:ring-primary-500' : 'dark:bg-gray-800'}`;
                
                const topRow = document.createElement('div');
                topRow.className = 'flex justify-between items-center mb-3'; 
                
                const departTimeDiv = document.createElement('div');
                departTimeDiv.className = 'text-lg font-semibold text-gray-900 dark:text-white flex items-center'; 
                departTimeDiv.innerHTML = `
                    <i class="far fa-clock mr-2 text-gray-500 dark:text-gray-400"></i>
                    <span>${formatTime(bus.departTime)}</span>
                    ${bus.isTomorrow ? '<span class="text-xs font-normal normal-case text-gray-500 dark:text-gray-400 ml-2 pt-1">(Tomorrow)</span>' : ''}
                `;
                
                const arriveTimeDiv = document.createElement('div');
                arriveTimeDiv.className = 'text-sm uppercase text-gray-500 dark:text-gray-400 flex items-center';
                arriveTimeDiv.innerHTML = `
                    <i class="fas fa-flag-checkered mr-2"></i>
                    Arrives: ${bus.arriveTime}
                `;
                
                topRow.appendChild(departTimeDiv);
                topRow.appendChild(arriveTimeDiv);
                busEntry.appendChild(topRow);

                const travelTimeDiv = document.createElement('div'); 
                travelTimeDiv.className = 'text-xs uppercase tracking-wide text-gray-500 dark:text-gray-400 mb-3 flex items-center';
                const travelMinutes = calculateTravelTime(
                    formatTime(bus.departTime),
                    bus.arriveTime
                );
                travelTimeDiv.innerHTML = `
                    <i class="fas fa-hourglass-half mr-2 fa-fw"></i>
                    Travel time: ${travelMinutes} minutes
                `;
                busEntry.appendChild(travelTimeDiv);

                const countdownDiv = document.createElement('div');
                countdownDiv.className = 'text-base uppercase font-bold text-primary-600 dark:text-primary-400 flex items-center'; 
                countdownDiv.innerHTML = `
                    <i class="fas fa-stopwatch mr-2 fa-fw"></i>
                    Departing in: ${formatCountdown(countdown)}
                `;
                busEntry.appendChild(countdownDiv);

                if (isNext) {
                    const progressBar = document.createElement('div');
                    progressBar.className = 'progress-bar';
                    progressBar.style.width = `${progress}%`;
                    busEntry.appendChild(progressBar);
                }

                nextBusesContainer.appendChild(busEntry);
            });
        }

        // Search Function Logic (needs scheduleLoaded check)
        const searchButtonInOverlay = searchOverlay.querySelector('#search-button');
        if (searchButtonInOverlay) {
             searchButtonInOverlay.addEventListener('click', () => {
                if (!scheduleLoaded) {
                     document.getElementById('search-results').innerHTML = `<p class="text-yellow-600 dark:text-yellow-400">Schedule is still loading, please wait...</p>`;
                     return;
                }
                const searchInput = document.getElementById('arrival-time-search');
                const desiredArrivalTimeStr = searchInput.value;
                const resultsContainer = document.getElementById('search-results');
                resultsContainer.innerHTML = ''; // Clear previous results
    
                if (!desiredArrivalTimeStr) {
                    resultsContainer.innerHTML = `<p class="text-red-600 dark:text-red-400">Please enter a desired arrival time.</p>`;
                    return;
                }

                // --- Check Direction --- 
                const direction = document.querySelector('.route-tab.active').dataset.direction;
                if (direction !== 'pzv2_to_hq') {
                    resultsContainer.innerHTML = `<p class="text-yellow-600 dark:text-yellow-400">Arrival time search is only available for the PZV2 → HQ route.</p>`;
                    return; 
                }
                // --- End Check Direction --- 
    
                try {
                    const now = getNowInDubaiTimezone();
                    
                    // Hardcode schedule and keys for PZV2 -> HQ route since we checked the direction
                    const schedule = pzv2_to_hq;
                    const arrivalKey = 'arriveHQ';
                    const departureKey = 'departPZV2';
                    const destination = 'HQ';

                    // Add check if schedule is loaded and valid
                    if (!schedule || schedule.length === 0) {
                         resultsContainer.innerHTML = `<p class="text-yellow-600 dark:text-yellow-400">Schedule data is empty or invalid. Cannot perform search.</p>`;
                         return;
                    }

                    const [targetHours, targetMinutes] = desiredArrivalTimeStr.split(':').map(Number);
                    
                    // Validate search time input
                    if (isNaN(targetHours) || isNaN(targetMinutes) || targetHours < 0 || targetHours > 23 || targetMinutes < 0 || targetMinutes > 59) {
                         resultsContainer.innerHTML = `<p class="text-red-600 dark:text-red-400">Invalid time format entered.</p>`;
                         return;
                    }

                    const targetArrivalDate = new Date(now); // Use today's date as reference
                    targetArrivalDate.setHours(targetHours, targetMinutes, 0, 0);

                    const relevantTrips = [];

                    schedule.forEach(trip => {
                        // Add checks for trip structure and time validity
                        if (!trip || !trip[arrivalKey] || !trip[departureKey]) return;

                        const [arrHours, arrMinutes] = trip[arrivalKey].split(':').map(Number);
                         if (isNaN(arrHours) || isNaN(arrMinutes)) return; // Skip invalid arrival times in schedule

                        const scheduledArrivalDate = new Date(now);
                        scheduledArrivalDate.setHours(arrHours, arrMinutes, 0, 0);

                        // Handle potential midnight wrap-around for comparison
                        if (scheduledArrivalDate <= targetArrivalDate) {
                             const [depHours, depMinutes] = trip[departureKey].split(':').map(Number);
                              if (isNaN(depHours) || isNaN(depMinutes)) return; // Skip invalid depart times

                             const scheduledDepartureDate = new Date(now);
                             scheduledDepartureDate.setHours(depHours, depMinutes, 0, 0);
                             
                             if (scheduledArrivalDate < scheduledDepartureDate) {
                                 scheduledDepartureDate.setDate(scheduledDepartureDate.getDate() -1);
                             }

                            relevantTrips.push({
                                departureDateTime: scheduledDepartureDate,
                                arrivalDateTime: scheduledArrivalDate,
                                departStr: trip[departureKey],
                                arriveStr: trip[arrivalKey]
                            });
                        }
                    });

                    // Sort by arrival time, latest first (this also means closest to target time is first)
                    relevantTrips.sort((a, b) => b.arrivalDateTime - a.arrivalDateTime);

                    const lastFiveTrips = relevantTrips.slice(0, 5); // Changed slice from 2 to 5

                    if (lastFiveTrips.length === 0) {
                        // Destination is always HQ now
                        resultsContainer.innerHTML = `<p class="text-gray-600 dark:text-gray-400">No buses found arriving at HQ by ${desiredArrivalTimeStr} today.</p>`; 
                    } else {
                        resultsContainer.innerHTML = `<h3 class="text-md uppercase font-semibold text-gray-800 dark:text-gray-200 mb-2">Latest buses arriving at HQ by ${desiredArrivalTimeStr} (up to 5):</h3>`; // Updated title
                        lastFiveTrips.forEach(trip => {
                            const travelMinutes = calculateTravelTime(trip.departStr, trip.arriveStr);
                            const tripElement = document.createElement('div');
                            tripElement.className = 'bg-white dark:bg-gray-800 p-3 rounded-md shadow-sm text-sm'; 
                            tripElement.innerHTML = `
                                <div class="flex justify-between items-center mb-1">
                                    <span class="text-gray-700 dark:text-gray-300">
                                        <i class="fas fa-clock text-gray-500 dark:text-gray-400 mr-1"></i> Departs PZV2: 
                                        <strong class="text-gray-900 dark:text-white">${trip.departStr}</strong>
                                    </span>
                                    <span class="text-gray-700 dark:text-gray-300">
                                        <i class="fas fa-flag-checkered text-gray-500 dark:text-gray-400 mr-1"></i> Arrives HQ: 
                                        <strong class="text-gray-900 dark:text-white">${trip.arriveStr}</strong>
                                    </span>
                                </div>
                                <div class="text-xs uppercase text-gray-500 dark:text-gray-400 mt-1">
                                    <i class="fas fa-hourglass-half mr-1"></i> Travel Time: ${travelMinutes} min
                                </div>
                            `;
                            resultsContainer.appendChild(tripElement);
                        });
                    }
                } catch (error) {
                    console.error("Search error:", error);
                    resultsContainer.innerHTML = `<p class="text-red-600 dark:text-red-400">Error processing search. Please check the time format.</p>`;
                }
            });
        } else {
            console.error("Search button within overlay not found!");
        }

        // Toggle full schedule (needs scheduleLoaded check)
        document.getElementById('toggleSchedule').addEventListener('click', function() {
            if (!scheduleLoaded) return; // Don't toggle if schedule not loaded
            const fullSchedule = document.getElementById('full-schedule');
            const button = this;
            const scheduleList = document.getElementById('schedule-list'); // Need list to populate
            const buttonSpan = button.querySelector('span'); // Get the span for text update
            
            if (fullSchedule.style.maxHeight && fullSchedule.style.maxHeight !== '0px') { // Check if currently expanded
                // Collapse
                fullSchedule.style.maxHeight = '0px';
                fullSchedule.style.opacity = '0';
                if (buttonSpan) buttonSpan.textContent = 'Show Full Schedule'; 
                button.querySelector('i').classList.replace('fa-calendar-times', 'fa-calendar-alt'); // Change icon
            } else {
                // Expand
                scheduleList.innerHTML = ''; 
                const direction = document.querySelector('.route-tab.active').dataset.direction;
                const schedule = direction === 'pzv2_to_hq' ? pzv2_to_hq : hq_to_pzv2;
                 if (schedule && schedule.length > 0) {
                     schedule.forEach(entry => {
                         if (!entry) return;
                         const departTimeStr = direction === 'pzv2_to_hq' ? entry.departPZV2 : entry.departHQ;
                         const arriveTimeStr = direction === 'pzv2_to_hq' ? entry.arriveHQ : entry.arrivePZV2;
                         if (!departTimeStr || !arriveTimeStr) return;
                         
                         const scheduleEntry = document.createElement('div');
                         scheduleEntry.className = 'flex justify-between items-center py-2 border-b border-gray-200 dark:border-gray-700 last:border-0';
                         
                         const timeInfo = document.createElement('div');
                         timeInfo.className = 'uppercase text-xs tracking-wide text-gray-700 dark:text-gray-300'; // Smaller text
                         timeInfo.innerHTML = `
                             <i class="fas fa-clock mr-1"></i>
                             ${departTimeStr} → ${arriveTimeStr}
                         `;
                         
                         const travelTime = document.createElement('div');
                         travelTime.className = 'text-xs uppercase text-gray-500 dark:text-gray-400'; // Smaller text
                         const travelMinutes = calculateTravelTime(departTimeStr, arriveTimeStr);
                         travelTime.innerHTML = `
                             <i class="fas fa-hourglass-half mr-1"></i>
                             ${travelMinutes} min
                         `;
                         
                         scheduleEntry.appendChild(timeInfo);
                         scheduleEntry.appendChild(travelTime);
                         scheduleList.appendChild(scheduleEntry);
                     });
                 } else {
                    scheduleList.innerHTML = '<p class="text-gray-500 dark:text-gray-400 text-sm">Schedule data not available.</p>';
                 }
                
                fullSchedule.style.opacity = '1';
                fullSchedule.style.maxHeight = fullSchedule.scrollHeight + "px"; 
                if (buttonSpan) buttonSpan.textContent = 'Hide Full Schedule';
                button.querySelector('i').classList.replace('fa-calendar-alt', 'fa-calendar-times'); // Change icon

                // Scroll to the full schedule section smoothly, aligning top
                setTimeout(() => {
                    fullSchedule.scrollIntoView({ behavior: 'smooth', block: 'start' }); // Changed block to 'start'
                }, 100); 
            }
        });

        // Direction change handler (User Click)
        document.querySelectorAll('.route-tab').forEach(tab => {
            tab.addEventListener('click', () => {
                const clickedDirection = tab.dataset.direction;
                 document.querySelectorAll('.route-tab').forEach(t => {
                     // Remove active classes (generic)
                     t.classList.remove('active', 
                                      'bg-primary-50', 'dark:bg-primary-700', 'dark:bg-primary-900', // Remove old dark bg possibilities 
                                      'text-primary-700', 'dark:text-white', 'dark:text-primary-300'); // Remove old dark text possibilities
                     // Add default inactive classes
                     t.classList.add('bg-white', 'dark:bg-gray-800', 'text-gray-700', 'dark:text-gray-300');
                 });
                 // Remove inactive styles from clicked tab
                 tab.classList.remove('bg-white', 'dark:bg-gray-800', 'text-gray-700', 'dark:text-gray-300');
                 // Apply NEW active styles
                 tab.classList.add('active', 'bg-primary-50', 'dark:bg-primary-700', 'text-primary-700', 'dark:text-white'); 

                // Update display for the manually clicked tab
                updateDisplay(); 
                
                // If full schedule is visible, collapse it using animation
                const fullSchedule = document.getElementById('full-schedule');
                const toggleButton = document.getElementById('toggleSchedule');
                // Check if it's currently expanded (maxHeight is not 0px)
                if (fullSchedule.style.maxHeight && fullSchedule.style.maxHeight !== '0px') { 
                    fullSchedule.style.maxHeight = '0px'; // Collapse it
                    fullSchedule.style.opacity = '0';
                    toggleButton.querySelector('i').classList.replace('fa-calendar-times', 'fa-calendar-alt');
                    toggleButton.querySelector('span').textContent = 'Show Full Schedule'; // Reset button text
                }
            });
        });

        // --- Initialisation ---
        async function initializeApp() {
            // 1. Load schedule
            await loadSchedule(); 
            if (!scheduleLoaded) {
                 console.error("Initialization failed: Schedule could not be loaded.");
                 return; // Stop initialization if schedule failed
            }

            // 2. Try Geolocation to set initial tab
            if (navigator.geolocation) {
                 console.log("Attempting geolocation...");
                 navigator.geolocation.getCurrentPosition(
                     (position) => { // Success
                         const userLat = position.coords.latitude;
                         const userLon = position.coords.longitude;
                         const distPZV2 = calculateDistance(userLat, userLon, pzv2Coords.lat, pzv2Coords.lon);
                         const distHQ = calculateDistance(userLat, userLon, hqCoords.lat, hqCoords.lon);
                         
                         const defaultDirection = (distPZV2 <= distHQ) ? 'pzv2_to_hq' : 'hq_to_pzv2';
                         console.log(`Geolocation success: User closer to ${defaultDirection === 'pzv2_to_hq' ? 'PZV2' : 'HQ'} (${distPZV2.toFixed(2)}km vs ${distHQ.toFixed(2)}km). Setting default route.`);
                         selectRouteTab(defaultDirection); // Selects tab and triggers initial updateDisplay
                         startUpdateInterval(); // Start interval *after* initial setup based on location
                     },
                     (error) => { // Error / Denied
                         console.warn(`Geolocation error (${error.code}): ${error.message}. Defaulting to PZV2 -> HQ.`);
                         selectRouteTab('pzv2_to_hq'); // Default tab (also triggers initial updateDisplay)
                         startUpdateInterval(); // Start interval *after* default setup
                     },
                     {
                         enableHighAccuracy: false, 
                         timeout: 10000, 
                         maximumAge: 60000 
                     }
                 );
             } else { // Geolocation not supported
                 console.warn("Geolocation is not supported by this browser. Defaulting to PZV2 -> HQ.");
                 selectRouteTab('pzv2_to_hq'); // Default tab (also triggers initial updateDisplay)
                 startUpdateInterval(); // Start interval *after* default setup
             }
        }

        initializeApp(); // Start the app initialization

        // Register service worker for PWA
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js')
                    .then(registration => {
                        console.log('ServiceWorker registration successful');
                    })
                    .catch(err => {
                        console.log('ServiceWorker registration failed: ', err);
                    });
            });
        }

        // --- DOM Elements --- 
        const authorizeButton = document.getElementById('authorize_button');
        const fetchEventButton = document.getElementById('fetch_event_button');
        const authStatusDiv = document.getElementById('auth_status');
        
        // --- GIS/GAPI Initialization ---
        function gapiLoaded() {
            gapi.load('client', initializeGapiClient);
        }

        async function initializeGapiClient() {
            // TODO: Authorize using API key
             // await gapi.client.init({
             //     apiKey: API_KEY, // Use API Key if available
             //     discoveryDocs: ["https://www.googleapis.com/discovery/v1/apis/calendar/v3/rest"],
             // });
            // For now, init without discoveryDocs until auth is done
            await gapi.client.load("https://www.googleapis.com/discovery/v1/apis/calendar/v3/rest");
            gapiInited = true;
            maybeEnableButtons();
        }

        function gisLoaded() {
            tokenClient = google.accounts.oauth2.initTokenClient({
                client_id: CLIENT_ID,
                scope: CALENDAR_SCOPE,
                callback: '', // Defined dynamically
            });
            gisInited = true;
            maybeEnableButtons();
        }

        function maybeEnableButtons() {
            if (gapiInited && gisInited) {
                authorizeButton.disabled = false;
                 authStatusDiv.textContent = 'Ready to sign in.';
            }
        }

        // --- Authorization Logic --- 
        authorizeButton.addEventListener('click', handleAuthClick);

        function handleAuthClick() {
            tokenClient.callback = async (resp) => {
                if (resp.error !== undefined) {
                    console.error('Google Auth Error:', resp);
                    authStatusDiv.textContent = 'Authorization failed.';
                    throw (resp);
                }
                // Auth successful
                authStatusDiv.textContent = 'Calendar Authorized!';
                authorizeButton.textContent = 'Calendar Authorized';
                authorizeButton.disabled = true;
                fetchEventButton.disabled = false;
                // No need to explicitly set token, gapi handles it after this callback
                console.log('GAPI client token set?', gapi.client.getToken()); 
            };

            // Check if we already have a token (might not work across reloads without more logic)
            if (gapi.client.getToken() === null) {
                // Prompt the user to select a Google Account and ask for consent to share their data
                // when establishing a new session.
                authStatusDiv.textContent = 'Requesting authorization...';
                tokenClient.requestAccessToken({prompt: 'consent'});
            } else {
                 // Skip display of account chooser and consent dialog for an existing session.
                 authStatusDiv.textContent = 'Requesting access token...';
                 tokenClient.requestAccessToken({prompt: ''}); 
            }
        }

        // --- Fetch Event Logic --- 
        fetchEventButton.addEventListener('click', fetchNextCalendarEvent);

        async function fetchNextCalendarEvent() {
            if (!gapiInited || !gisInited || !gapi.client.getToken()) {
                 authStatusDiv.textContent = 'Please authorize first.';
                 return;
            }
            authStatusDiv.textContent = 'Fetching next event...';
            try {
                const request = {
                    'calendarId': 'primary',
                    'timeMin': (new Date()).toISOString(),
                    'showDeleted': false,
                    'singleEvents': true,
                    'maxResults': 1,
                    'orderBy': 'startTime'
                };
                // If using API Key, add it here: request.key = API_KEY;

                const response = await gapi.client.calendar.events.list(request);

                const events = response.result.items;
                if (!events || events.length === 0) {
                    authStatusDiv.textContent = 'No upcoming events found.';
                    console.log('No upcoming events found.');
                    return;
                }

                const nextEvent = events[0];
                const when = nextEvent.start.dateTime || nextEvent.start.date;
                console.log(`Next event: ${nextEvent.summary} at ${when}`);
                authStatusDiv.textContent = `Next: ${nextEvent.summary.substring(0,20)}...`;

                // Extract time and trigger search (Needs timezone handling!)
                let eventTime = null;
                if (nextEvent.start.dateTime) { 
                    // This is a specific time. CAUTION: Timezone needs careful handling.
                    // Google API returns ISO 8601 format like "2023-10-27T10:00:00+04:00"
                    // We need to convert this to Dubai HH:MM for the search input.
                    try {
                         const eventDate = new Date(when); 
                         // Format this date *as if it were in Dubai time* for our HH:MM output.
                         // This is tricky. A robust library like date-fns-tz is better.
                         // Simple approach: Assume event time IS Dubai time (often wrong!)
                         // Or try to adjust based on offset if present (also complex).
                         
                         // Quick and dirty: just extract HH:MM from ISO string if possible
                         const timeMatch = when.match(/T(\d{2}:\d{2})/);
                         if (timeMatch && timeMatch[1]) {
                             eventTime = timeMatch[1];
                         } else { 
                              // Fallback: Format the Date object using *local* browser TZ, may not be Dubai.
                              eventTime = eventDate.toLocaleTimeString('en-GB', {hour: '2-digit', minute: '2-digit', hourCycle: 'h23'});
                         }
                    } catch (e) {
                         console.error("Error parsing event date/time:", e);
                         authStatusDiv.textContent = 'Error parsing event time.';
                         return;
                    }
                } else if (nextEvent.start.date) {
                    // All-day event. What time to use? Maybe 00:00 or skip?
                    console.log("Next event is an all-day event. Skipping search.");
                    authStatusDiv.textContent += ' (All-day event)';
                    return;
                }

                if (eventTime) {
                    // Populate search and click
                    const searchInput = document.getElementById('arrival-time-search');
                    const searchButton = document.getElementById('search-button'); // Button inside overlay
                    const overlay = document.getElementById('search-overlay');

                    if (searchInput && searchButton && overlay) {
                        searchInput.value = eventTime; 
                        overlay.classList.remove('hidden'); // Show the overlay
                        searchButton.click(); // Trigger the search
                        // Optionally scroll to results after a short delay
                         setTimeout(() => {
                              const resultsDiv = document.getElementById('search-results');
                              if (resultsDiv) resultsDiv.scrollIntoView({ behavior: 'smooth', block: 'nearest'});
                         }, 300);
                    } else {
                         console.error("Search input, button, or overlay not found for calendar event trigger.");
                    }
                }

            } catch (error) {
                console.error('Error fetching calendar events:', error);
                authStatusDiv.textContent = 'Error fetching events.';
            }
        }
    </script>
    <!-- Add onload callbacks for GAPI/GIS -->
    <script async defer src="https://apis.google.com/js/api.js" onload="gapiLoaded()"></script>
    <script async defer src="https://accounts.google.com/gsi/client" onload="gisLoaded()"></script>
</body>
</html>